hist(scoary.inf$Benjamini_H_p, breaks = 50)
hist(scoary.inf$Empirical_p)
View(res)
View(data)
View(treeWAS.data)
args(treeWAS::treeWAS)
1200 * 12
X <- data$X
y <- data$y
n <- length(y)
tree <- data$tree
timestamp <- format(Sys.time(), "%Y-%m-%d_%H-%M-%S")
# make sure temp directory exists
if (!dir.exists(tmpdir)) {
dir.create(tmpdir, recursive = TRUE)
}
tmpdir_time <- file.path(tmpdir, timestamp)
dir.create(tmpdir_time, recursive = TRUE)
# sample names check
if (is.null(rownames(X))) rownames(X) <- paste0("sample_", seq(1:n))
if (is.null(names(y))) names(y) <- rownames(X)
if (!all(names(y) %in% rownames(X))) {
stop("Sample names in y must match rownames of X")
}
samples <- names(y)
# make phenotype file
pheno_file <- file.path(tmpdir_time, "phenotypes.txt")
pheno_df <- data.frame(sample = samples, phenotype = y[samples],
stringsAsFactors = FALSE)
write.table(pheno_df, pheno_file, sep = "\t", quote = FALSE,
row.names = FALSE, col.names = TRUE)
# make genotype file
geno_file <- file.path(tmpdir_time, "variants.pres.tsv")
mat <- t(X[samples, , drop = FALSE])
geno_out <- data.frame(variant = rownames(mat), mat, check.names = FALSE)
write.table(geno_out, geno_file, sep = "\t", quote = FALSE,
row.names = FALSE, col.names = TRUE)
# make sample list file
sample_file <- file.path(tmpdir_time, "sample_list.txt")
writeLines(samples, sample_file)
# distances / similarities from tree
dist_file <- sim_file <- NULL
phylo = TRUE
pyseer_phylo = TRUE
tree_file <- file.path(tmpdir_time, "core_genome.tree")
# Write tree to Newick file
ape::write.tree(tree, file = tree_file)
tmpdir = "pyseer_temp"
X <- data$X
y <- data$y
n <- length(y)
tree <- data$tree
timestamp <- format(Sys.time(), "%Y-%m-%d_%H-%M-%S")
# make sure temp directory exists
if (!dir.exists(tmpdir)) {
dir.create(tmpdir, recursive = TRUE)
}
tmpdir_time <- file.path(tmpdir, timestamp)
dir.create(tmpdir_time, recursive = TRUE)
# sample names check
if (is.null(rownames(X))) rownames(X) <- paste0("sample_", seq(1:n))
if (is.null(names(y))) names(y) <- rownames(X)
if (!all(names(y) %in% rownames(X))) {
stop("Sample names in y must match rownames of X")
}
samples <- names(y)
# make phenotype file
pheno_file <- file.path(tmpdir_time, "phenotypes.txt")
pheno_df <- data.frame(sample = samples, phenotype = y[samples],
stringsAsFactors = FALSE)
write.table(pheno_df, pheno_file, sep = "\t", quote = FALSE,
row.names = FALSE, col.names = TRUE)
# make genotype file
geno_file <- file.path(tmpdir_time, "variants.pres.tsv")
mat <- t(X[samples, , drop = FALSE])
geno_out <- data.frame(variant = rownames(mat), mat, check.names = FALSE)
write.table(geno_out, geno_file, sep = "\t", quote = FALSE,
row.names = FALSE, col.names = TRUE)
# make sample list file
sample_file <- file.path(tmpdir_time, "sample_list.txt")
writeLines(samples, sample_file)
# distances / similarities from tree
dist_file <- sim_file <- NULL
tree_file <- file.path(tmpdir_time, "core_genome.tree")
# Write tree to Newick file
ape::write.tree(tree, file = tree_file)
# compute phylo distances
cmd_str <- paste0("python scripts/phylogeny_distance.py ", file.path(tmpdir_time, "core_genome.tree"))
full_cmd <- paste(conda_bin, "run -n", pyseer_env, cmd_str,
paste0("> ", file.path(tmpdir_time, "distances.txt")))
pyseer_env = "pyseer_x86"
full_cmd <- paste(conda_bin, "run -n", pyseer_env, cmd_str,
paste0("> ", file.path(tmpdir_time, "distances.txt")))
message("Running: ", full_cmd)
system(full_cmd)
# compute kinship
cmd_str <- paste0("similarity_pyseer --pres ", file.path(tmpdir_time, "variants.pres.tsv"), " ", file.path(tmpdir_time, "sample_list.txt"))
full_cmd <- paste(conda_bin, "run -n", pyseer_env, cmd_str,
paste0("> ", file.path(tmpdir_time, "similarities.txt")))
message("Running: ", full_cmd)
system(full_cmd)
# read the similarity matrix
sim_file <- file.path(tmpdir_time, "similarities.txt")
sim <- as.matrix(read.table(sim_file, header = TRUE, row.names = 1, check.names = FALSE))
X <- data$X
y <- data$y
n <- length(y)
tree <- data$tree
timestamp <- format(Sys.time(), "%Y-%m-%d_%H-%M-%S")
# make sure temp directory exists
if (!dir.exists(tmpdir)) {
dir.create(tmpdir, recursive = TRUE)
}
tmpdir_time <- file.path(tmpdir, timestamp)
dir.create(tmpdir_time, recursive = TRUE)
# sample names check
if (is.null(rownames(X))) rownames(X) <- paste0("sample_", seq(1:n))
if (is.null(names(y))) names(y) <- rownames(X)
if (!all(names(y) %in% rownames(X))) {
stop("Sample names in y must match rownames of X")
}
samples <- names(y)
# make phenotype file
pheno_file <- file.path(tmpdir_time, "phenotypes.txt")
pheno_df <- data.frame(sample = samples, phenotype = y[samples],
stringsAsFactors = FALSE)
write.table(pheno_df, pheno_file, sep = "\t", quote = FALSE,
row.names = FALSE, col.names = TRUE)
# make genotype file
geno_file <- file.path(tmpdir_time, "variants.pres.tsv")
mat <- t(X[samples, , drop = FALSE])
geno_out <- data.frame(variant = rownames(mat), mat, check.names = FALSE)
write.table(geno_out, geno_file, sep = "\t", quote = FALSE,
row.names = FALSE, col.names = TRUE)
# make sample list file
sample_file <- file.path(tmpdir_time, "sample_list.txt")
writeLines(samples, sample_file)
# distances / similarities from tree
dist_file <- sim_file <- NULL
# compute kinship
cmd_str <- paste0("similarity_pyseer --pres ", file.path(tmpdir_time, "variants.pres.tsv"), " ", file.path(tmpdir_time, "sample_list.txt"))
full_cmd <- paste(conda_bin, "run -n", pyseer_env, cmd_str,
paste0("> ", file.path(tmpdir_time, "similarities.txt")))
message("Running: ", full_cmd)
# compute kinship
cmd_str <- paste0("similarity_pyseer --pres ", file.path(tmpdir_time, "variants.pres.tsv"), " ", file.path(tmpdir_time, "sample_list.txt"))
full_cmd <- paste(conda_bin, "run -n", pyseer_env, cmd_str,
paste0("> ", file.path(tmpdir_time, "similarities.tsv")))
message("Running: ", full_cmd)
system(full_cmd)
# sample names standard
rownames(X) <- paste0("sample_", seq(1:n))
names(y) <- rownames(X)
if (!all(names(y) %in% rownames(X))) {
stop("Sample names in y must match rownames of X")
}
samples <- names(y)
# make phenotype file
pheno_file <- file.path(tmpdir_time, "phenotypes.txt")
pheno_df <- data.frame(sample = samples, phenotype = y[samples],
stringsAsFactors = FALSE)
write.table(pheno_df, pheno_file, sep = "\t", quote = FALSE,
row.names = FALSE, col.names = TRUE)
# make genotype file
geno_file <- file.path(tmpdir_time, "variants.pres.tsv")
mat <- t(X[samples, , drop = FALSE])
geno_out <- data.frame(variant = rownames(mat), mat, check.names = FALSE)
write.table(geno_out, geno_file, sep = "\t", quote = FALSE,
row.names = FALSE, col.names = TRUE)
# make sample list file
sample_file <- file.path(tmpdir_time, "sample_list.txt")
writeLines(samples, sample_file)
# distances / similarities from tree
dist_file <- sim_file <- NULL
# compute kinship
cmd_str <- paste0("similarity_pyseer --pres ", file.path(tmpdir_time, "variants.pres.tsv"), " ", file.path(tmpdir_time, "sample_list.txt"))
full_cmd <- paste(conda_bin, "run -n", pyseer_env, cmd_str,
paste0("> ", file.path(tmpdir_time, "similarities.tsv")))
message("Running: ", full_cmd)
system(full_cmd)
sanity = X %*% t(X)
View(sanity)
sanity = X %*% t(X) / ncol(X)
hist(sanity)
hist(sanity, breaks = 50)
write.table(geno_out,  file.path(tmpdir_time, "variants.pres.Rtab"),
sep = "\t", quote = FALSE, row.names = FALSE, col.names = TRUE
)
# compute kinship
cmd_str <- paste0("similarity_pyseer --pres ", file.path(tmpdir_time, "variants.pres.Rtab"), " ", file.path(tmpdir_time, "sample_list.txt"))
full_cmd <- paste(conda_bin, "run -n", pyseer_env, cmd_str,
paste0("> ", file.path(tmpdir_time, "similarities.tsv")))
message("Running: ", full_cmd)
system(full_cmd)
View(X)
geno_out <- data.frame(Gene = rownames(mat), mat, check.names = FALSE)
write.table(geno_out, geno_file, sep = "\t", quote = FALSE,
row.names = FALSE, col.names = TRUE)
write.table(geno_out,  file.path(tmpdir_time, "variants.pres.Rtab"),
sep = "\t", quote = FALSE, row.names = FALSE, col.names = TRUE
)
# make sample list file
sample_file <- file.path(tmpdir_time, "sample_list.txt")
writeLines(samples, sample_file)
# distances / similarities from tree
dist_file <- sim_file <- NULL
# compute kinship
cmd_str <- paste0("similarity_pyseer --pres ", file.path(tmpdir_time, "variants.pres.Rtab"), " ", file.path(tmpdir_time, "sample_list.txt"))
full_cmd <- paste(conda_bin, "run -n", pyseer_env, cmd_str,
paste0("> ", file.path(tmpdir_time, "similarities.tsv")))
message("Running: ", full_cmd)
system(full_cmd)
# compute kinship
cmd_str <- paste0("similarity --pres ", file.path(tmpdir_time, "variants.pres.Rtab"), " ", file.path(tmpdir_time, "sample_list.txt"))
full_cmd <- paste(conda_bin, "run -n", pyseer_env, cmd_str,
paste0("> ", file.path(tmpdir_time, "similarities.txt")))
message("Running: ", full_cmd)
system(full_cmd)
# compute kinship
cmd_str <- paste0("pyseer.similarity --pres ", file.path(tmpdir_time, "variants.pres.Rtab"), " ", file.path(tmpdir_time, "sample_list.txt"))
full_cmd <- paste(conda_bin, "run -n", pyseer_env, cmd_str,
paste0("> ", file.path(tmpdir_time, "similarities.txt")))
message("Running: ", full_cmd)
system(full_cmd)
# compute kinship
cmd_str <- paste0("pyseer.similarity_pyseer --pres ", file.path(tmpdir_time, "variants.pres.Rtab"), " ", file.path(tmpdir_time, "sample_list.txt"))
full_cmd <- paste(conda_bin, "run -n", pyseer_env, cmd_str,
paste0("> ", file.path(tmpdir_time, "similarities.txt")))
message("Running: ", full_cmd)
system(full_cmd)
conda_bin
# compute kinship
cmd_str <- paste0("similarity --pres ", file.path(tmpdir_time, "variants.pres.Rtab"), " ", file.path(tmpdir_time, "sample_list.txt"))
full_cmd <- paste(conda_bin, "run -n", pyseer_env, cmd_str,
paste0("> ", file.path(tmpdir_time, "similarities.txt")))
message("Running: ", full_cmd)
system(full_cmd)
# compute kinship
cmd_str <- paste0("similarity_pyseer --pres ", file.path(tmpdir_time, "variants.pres.Rtab"), " ", file.path(tmpdir_time, "sample_list.txt"))
full_cmd <- paste(conda_bin, "run -n", pyseer_env, cmd_str,
paste0("> ", file.path(tmpdir_time, "similarities.txt")))
message("Running: ", full_cmd)
system(full_cmd)
conda_bin
View(sanity)
colMeans(X)
hist(colMeans(X))
hist(colMeans(X), breaks = 50)
tr <- ape::keep.tip(tree, samples)
if (method == "fixed") {
D <- ape::cophenetic.phylo(tr)[samples, samples]
dist_file <- file.path(tmpdir_time, "distances.txt")
write.table(D, dist_file, sep = "\t", quote = FALSE,
row.names = TRUE, col.names = TRUE)
}
method = "fixed"
if (method == "fixed") {
D <- ape::cophenetic.phylo(tr)[samples, samples]
dist_file <- file.path(tmpdir_time, "distances.txt")
write.table(D, dist_file, sep = "\t", quote = FALSE,
row.names = TRUE, col.names = TRUE)
}
tr <- ape::keep.tip(tree, samples)
View(tree)
X <- data$X
y <- data$y
n <- length(y)
tree <- data$tree
timestamp <- format(Sys.time(), "%Y-%m-%d_%H-%M-%S")
# make sure temp directory exists
if (!dir.exists(tmpdir)) {
dir.create(tmpdir, recursive = TRUE)
}
tmpdir_time <- file.path(tmpdir, timestamp)
dir.create(tmpdir_time, recursive = TRUE)
# sample names standard
if (is.null(rownames(X))) rownames(X) <- paste0("sample_", seq(1:n))
(is.null(names(y))) names(y) <- rownames(X)
if (!all(names(y) %in% rownames(X))) {
stop("Sample names in y must match rownames of X")
}
if (is.null(names(y))) names(y) <- rownames(X)
if (!all(names(y) %in% rownames(X))) {
stop("Sample names in y must match rownames of X")
}
samples <- names(y)
# make phenotype file
pheno_file <- file.path(tmpdir_time, "phenotypes.txt")
pheno_df <- data.frame(sample = samples, phenotype = y[samples],
stringsAsFactors = FALSE)
write.table(pheno_df, pheno_file, sep = "\t", quote = FALSE,
row.names = FALSE, col.names = TRUE)
# make genotype file
geno_file <- file.path(tmpdir_time, "variants.pres.tsv")
mat <- t(X[samples, , drop = FALSE])
geno_out <- data.frame(Gene = rownames(mat), mat, check.names = FALSE)
write.table(geno_out, geno_file, sep = "\t", quote = FALSE,
row.names = FALSE, col.names = TRUE)
write.table(geno_out,  file.path(tmpdir_time, "variants.pres.Rtab"),
sep = "\t", quote = FALSE, row.names = FALSE, col.names = TRUE
)
# make sample list file
sample_file <- file.path(tmpdir_time, "sample_list.txt")
writeLines(samples, sample_file)
# distances / similarities from tree
dist_file <- sim_file <- NULL
tr <- ape::keep.tip(tree, samples)
if (method == "fixed") {
D <- ape::cophenetic.phylo(tr)[samples, samples]
dist_file <- file.path(tmpdir_time, "distances.txt")
write.table(D, dist_file, sep = "\t", quote = FALSE,
row.names = TRUE, col.names = TRUE)
}
View(D)
View(D)
write.table(D, dist_file, sep = "\t", quote = FALSE,
row.names = TRUE, col.names = NA)
View(sanity)
dimX()
dim(X)
# compute kinship
K <- X %*% t(X)
View(K)
K_norm <- K / ncol(X)
D <- 1 - K_norm
View(D)
library(proxy)
D <- dist(X, method = "binary")
# make pyseer command
cmd <- c("pyseer",
paste0("--phenotypes ", pheno_file),
paste0("--pres ", geno_file))
if (!is.null(dist_file))  cmd <- c(cmd, paste0("--distances ", dist_file))
if (!is.null(sim_file))   cmd <- c(cmd, paste0("--similarity ", sim_file), "--lmm")
if (method == "elasticnet") cmd <- c(cmd, "--wg enet --alpha 1")
cmd_str <- paste(cmd, collapse = " ")
# prepend conda run
full_cmd <- paste(conda_bin, "run -n", pyseer_env, cmd_str,
paste0("> ", file.path(tmpdir_time, output)))
output = "pyseer_out.txt"
# prepend conda run
full_cmd <- paste(conda_bin, "run -n", pyseer_env, cmd_str,
paste0("> ", file.path(tmpdir_time, output)))
message("Running: ", full_cmd)
system(full_cmd)
# get results
res <- read.table(file.path(tmpdir_time, output), header = TRUE, sep = "\t", stringsAsFactors = FALSE)
View(res)
method = "mixed"
if (method == "fixed") {
D <- ape::cophenetic.phylo(tr)[samples, samples]
dist_file <- file.path(tmpdir_time, "distances.txt")
write.table(D, dist_file, sep = "\t", quote = FALSE,
row.names = TRUE, col.names = NA)
}
else if (method == "mixed") {
D <- ape::cophenetic.phylo(tr)[samples, samples]
sim <- exp(-D)   # similarity from distances
sim_file <- file.path(tmpdir_time, "similarities.txt")
write.table(sim, sim_file, sep = "\t", quote = FALSE,
row.names = TRUE, col.names = NA)
# make pyseer command
cmd <- c("pyseer",
paste0("--phenotypes ", pheno_file),
paste0("--pres ", geno_file))
if (!is.null(dist_file))  cmd <- c(cmd, paste0("--distances ", dist_file))
if (!is.null(sim_file))   cmd <- c(cmd, paste0("--similarity ", sim_file), "--lmm")
if (method == "elasticnet") cmd <- c(cmd, "--wg enet --alpha 1")
cmd_str <- paste(cmd, collapse = " ")
# prepend conda run
full_cmd <- paste(conda_bin, "run -n", pyseer_env, cmd_str,
paste0("> ", file.path(tmpdir_time, output)))
message("Running: ", full_cmd)
system(full_cmd)
# make pyseer command
cmd <- c("pyseer",
paste0("--phenotypes ", pheno_file),
paste0("--pres ", geno_file))
dist_file
!is.null(dist_file)
if (!is.null(dist_file))  cmd <- c(cmd, paste0("--distances ", dist_file))
if (!is.null(sim_file))   cmd <- c(cmd, paste0("--similarity ", sim_file), "--lmm")
if (method == "elasticnet") cmd <- c(cmd, "--wg enet --alpha 1")
cmd_str <- paste(cmd, collapse = " ")
# prepend conda run
full_cmd <- paste(conda_bin, "run -n", pyseer_env, cmd_str,
paste0("> ", file.path(tmpdir_time, output)))
message("Running: ", full_cmd)
# make pyseer command
cmd <- c("pyseer",
paste0("--phenotypes ", pheno_file),
paste0("--pres ", geno_file))
cmd
if (!is.null(dist_file))  cmd <- c(cmd, paste0("--distances ", dist_file))
cmd
# make pyseer command
cmd <- c("pyseer",
paste0("--phenotypes ", pheno_file),
paste0("--pres ", geno_file))
if (method == "fixed") {cmd <- c(cmd, paste0("--distances ", dist_file)) }
if (method == "mixed") {cmd <- c(cmd, paste0("--similarity ", sim_file), "--lmm")}
if (method == "elasticnet") cmd <- c(cmd, "--wg enet --alpha 1")
cmd_str <- paste(cmd, collapse = " ")
# prepend conda run
full_cmd <- paste(conda_bin, "run -n", pyseer_env, cmd_str,
paste0("> ", file.path(tmpdir_time, output)))
message("Running: ", full_cmd)
system(full_cmd)
# get results
res <- read.table(file.path(tmpdir_time, output), header = TRUE, sep = "\t", stringsAsFactors = FALSE)
View(res)
str_sub(method, 1, -6)
substr(method, 1, nchar(method) - 5)
View(data)
colnames(data$X)
rownames(data$X)
View(data)
jaccard_sim <- function(mat) {
mat <- mat > 0
inter <- tcrossprod(mat)
sums <- rowSums(mat)
union <- outer(sums, sums, "+") - inter
inter / union
}
sim <- jaccard_sim(data$X)
View(sim)
hist(sim[,1])
hist(sim[,1],breaks = 50\)
hist(sim[,1],breaks = 50)
# compute kinship with normalized 1 - GG^T
K <- tcrossprod(X)
View(K)
G = 2 * X - 1
K <- tcrossprod(G)
K_norm <- K / ncol(G)
View(K_norm)
args(treeWAS::treeWAS)
treeWAS.data <- mGWAS::generate_data(n, p, s, joint_X, y_given_X, X_hyperparams,
y_given_X_hyperparams, amplitude, ground_truth)
View(treeWAS.data)
# try methods
treeWAS.inf <- treeWAS_wrapper(treeWAS.data, method = "terminal")
treeWAS.inf <- oracle_treeWAS_wrapper(treeWAS.data, method = "terminal")
treeWAS.inf <- oracle_treeWAS_wrapper(treeWAS.data, method = "terminal")
load_all()
treeWAS.inf <- oracle_treeWAS_wrapper(treeWAS.data, method = "terminal")
load_all()
treeWAS.inf <- oracle_treeWAS_wrapper(treeWAS.data, method = "terminal")
treeWAS.inf <- treeWAS_tree_wrapper(treeWAS.data, method = "terminal")
treeWAS.inf <- treeWAS_no_subs_wrapper(treeWAS.data, method = "terminal")
View(treeWAS.inf)
args(mGWAS::coalescent.sim.mod)
mGWAS::coalescent.sim.mod
treeWAS::phen.sim(tree, n.subs = n.phen.subs, grp.min = grp.min, seed = seed)
treeWAS::phen.sim
rbinom(1000, 1, 0.5) + rnorm(1000, 0, 1)
treeWAS::coalescent.sim
View(treeWAS.data)
View(tree)
View(treeWAS.data)
phen.list <- treeWAS::phen.sim(tree = tree, n.subs = 15, grp.min = 0.25, seed = seed)
View(phen.list)
View(data)
snps.list <- snp.sim.mod(n.snps = 5000, n.subs = 1, tree = tree)
View(snps.list)
treeWAS::snp.sim
treeWAS::snp.sim.Q
treeWAS::snp.sim
min(tree$edge[,1])-1
# generate phen.sim according to tree and default params p times and take average
## get list of phenotype simulation output
phen.list <- treeWAS::phen.sim(tree, n.subs =  15, grp.min = 0.25, seed = seed)
View(phen.list)
View(phen.list)
## get phenotype for terminal nodes only
phen <- phen.list$phen
## get phenotype for all nodes,
## terminal and internal
phen.nodes <- phen.list$phen.nodes
phen
phen.noes
phen.nodes
phen.loci
## get the indices of phen.subs (ie. branches)
phen.loci <- phen.list$phen.loci
phen.loci
phen.nodes
document()
load_all()
View(y_given_X_hyperparams)
# testing
seed <- 1234
n <- 200
p <- 1000
s <- 0
amplitude <- 0.25
# test treeWAS and simurg
joint_X <- "treeWAS_mGWAS"
# joint_X <- "simurg"
y_given_X <- "linear"
# treeWAS X_hyperparams
X_hyperparams <- list(assoc.prob = 90, n.snps.assoc = 0, n.subs = 4, set = 1)
# simurg X_hyperparams
# X_hyperparams <- list(prob.gene.gain = 1e-08, prob.gene.loss = 1e-11, sub.rate = 5e-12)
y_given_X_hyperparams <- list(family = "gaussian")
# y_given_X_hyperparams <- list(family = "binomial")
y_given_X_hyperparams <- list(order = 4)
# nonnulls
ground_truth <- list(nonnulls = R.utils::withSeed(sample(p, s), seed = seed))
treeWAS.data <- mGWAS::generate_data(n, p, s, joint_X, y_given_X, X_hyperparams,
y_given_X_hyperparams, amplitude, ground_truth)
View(treeWAS.data)
